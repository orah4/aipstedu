<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- ‚úÖ Tailwind (single include) + Typography plugin -->
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <title>AI‚ÄìICT Instructional Support</title>

  <style>
    /* ===============================
       CHATGPT-STYLE CHAT FIX
    ================================ */

    .chat-row { display:flex; width:100%; }

    /* USER (RIGHT) */
    .chat-row.user { justify-content:flex-end; }
    .chat-row.user .bubble{
      max-width: 85%;
      background:#020617;
      color:#fff;
      padding:12px 14px;
      border-radius:16px 16px 0 16px;
      line-height:1.6;
      white-space:pre-wrap;
      word-break:break-word;
    }
    @media (min-width: 640px){
      .chat-row.user .bubble{ max-width:70%; }
    }

    /* ASSISTANT (LEFT ‚Äì FULL WIDTH LIKE INPUT) */
    .chat-row.assistant { justify-content:flex-start; }
    .chat-row.assistant .bubble{
      width:100%;
      max-width:100%;
      background:#f1f5f9;
      color:#020617;
      padding:14px 16px;
      border-radius:16px 16px 16px 0;
      line-height:1.7;
      white-space:pre-wrap;
      word-break:break-word;
    }
    

#scrollToBottomBtn {
  opacity: 0;
  transform: translateX(-50%) scale(0.9);
}

#scrollToBottomBtn:not(.hidden) {
  opacity: 1;
  transform: translateX(-50%) scale(1);
}


 /* ===============================
     CHATGPT-LIKE RESPONSE DENSITY
  ================================ */


   /* ‚úÖ Tight, professional spacing for assistant output */
.ai-content .prose {
  max-width: 100%;
}

.ai-content .prose p {
  margin: 0.35rem 0 !important;
}

.ai-content .prose li {
  margin: 0.2rem 0 !important;
}

.ai-content .prose h1,
.ai-content .prose h2,
.ai-content .prose h3 {
  margin: 0.8rem 0 0.35rem !important;
  line-height: 1.25;
}





/* Assistant text size (clean & readable) */
.chat-row.assistant .prose {
  font-size: 0.95rem;      /* slightly bigger than before */
  line-height: 1.6;
}

/* Paragraph spacing (professional, compact) */
.chat-row.assistant .prose p {
  margin-top: 0.35rem !important;
  margin-bottom: 0.55rem !important;
}

/* Numbered & bullet lists */
.chat-row.assistant .prose ol,
.chat-row.assistant .prose ul {
  margin-top: 0.5rem !important;
  margin-bottom: 0.6rem !important;
  padding-left: 1.25rem;
}



/* List items tighter */
.chat-row.assistant .prose li {
  margin-top: 0.25rem !important;
  margin-bottom: 0.25rem !important;
}

/* Headings: clear but not spaced out */
.chat-row.assistant .prose h1,
.chat-row.assistant .prose h2,
.chat-row.assistant .prose h3 {
  margin-top: 0.9rem !important;
  margin-bottom: 0.35rem !important;
  line-height: 1.3;
}




  /* Tighten assistant message spacing */
  .chat-row.assistant .bubble {
    line-height: 1.55;   /* tighter but readable */
  }

  /* Override Tailwind prose spacing */
  .chat-row.assistant .prose p {
    margin-top: 0.4rem !important;
    margin-bottom: 0.4rem !important;
  }

  .chat-row.assistant .prose ol,
  .chat-row.assistant .prose ul {
    margin-top: 0.5rem !important;
    margin-bottom: 0.5rem !important;
    padding-left: 1.25rem;
  }

  .chat-row.assistant .prose li {
    margin-top: 0.25rem !important;
    margin-bottom: 0.25rem !important;
  }

  .chat-row.assistant .prose h1,
  .chat-row.assistant .prose h2,
  .chat-row.assistant .prose h3 {
    margin-top: 1rem !important;
    margin-bottom: 0.4rem !important;
    line-height: 1.3;
  }


    /* Markdown safety */
    .chat-row.assistant .prose{ max-width:100%; }

    /* ‚úÖ Mobile viewport stability (helps iOS/Android) */
    :root { --app-vh: 100vh; }
    @supports (height: 100dvh) {
      :root { --app-vh: 100dvh; }
    }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 dark:text-gray-100 overflow-hidden"
      style="height: var(--app-vh);">

  <div class="h-full flex">

    <!-- ================= SIDEBAR ================= -->
    <!-- ‚úÖ Mobile: fixed overlay; Desktop: normal column -->
    <aside id="sidebar"
      class="bg-gray-900 text-white w-72 md:w-64
             hidden md:flex flex-col
             md:static
             fixed inset-y-0 left-0 z-40">

      <div class="p-4 font-bold text-lg border-b border-gray-700">
        AI‚ÄìICT Tutor
      </div>

      <nav class="flex-1 p-3 space-y-2 text-sm overflow-y-auto">
        <button data-role="all" onclick="showView('chat')" class="nav-btn">üí¨ Tutor Chat</button>
        <button data-role="admin" onclick="showView('ingest')" class="nav-btn">üìö Ingest Knowledge</button>
        <button data-role="lecturer" onclick="showView('lesson')" class="nav-btn">üìù Lesson Generator</button>
        <button data-role="lecturer" onclick="showView('rubric')" class="nav-btn">‚úÖ Rubric Feedback</button>
        <button data-role="student" onclick="showView('survey')" class="nav-btn">üìä ICT Survey</button>

        <button data-role="admin" onclick="location.href='/admin/users'" class="nav-btn">
          üë§ User Management
        </button>

        <button data-role="all" onclick="location.href='/change-password'" class="nav-btn">
          üîë Change Password
        </button>

        <button data-role="admin" onclick="logs()" class="nav-btn">üìÑ View Logs</button>

        <button data-role="admin" onclick="showView('survey-responses')" class="nav-btn">
          üìã Survey Responses
        </button>
      </nav>

      <div class="p-3 border-t border-gray-700 text-xs text-gray-400">
        Offline-first ‚Ä¢ GGUF ‚Ä¢ RAG
      </div>
    </aside>

    <!-- ================= MAIN ================= -->
    <div class="flex-1 flex flex-col min-w-0">

      <!-- ‚úÖ Sticky header (mobile friendly) -->
      <header class="sticky top-0 z-30 bg-white/95 dark:bg-gray-800/95 backdrop-blur
                     px-3 sm:px-4 py-3 flex justify-between items-center gap-3">
        <div class="flex items-center gap-3 min-w-0">
          <button class="md:hidden text-xl" onclick="toggleSidebar()">‚ò∞</button>
          <h1 class="font-semibold truncate">AI‚ÄìICT Instructional Support</h1>
        </div>

        <div class="flex items-center gap-2 sm:gap-3">
          <span class="hidden sm:inline text-sm opacity-70">
            {{ username }} ({{ role }})
          </span>
          <a href="{{ url_for('logout') }}"
            class="px-3 py-1 rounded bg-black text-white text-sm">
            Logout
          </a>
          <button onclick="toggleDarkMode()">üåô</button>
        </div>
      </header>

      <!-- ‚úÖ Responsive padding + scroll -->
      <main class="flex-1 overflow-y-auto p-3 sm:p-6">

        <!-- ================= CHAT ================= -->

       
        <!-- Scroll to bottom -->
<button id="scrollToBottomBtn"
  class="hidden fixed bottom-28
         left-1/2 -translate-x-1/2
         h-10 w-10 rounded-full
         bg-white dark:bg-gray-800
         text-gray-700 dark:text-gray-200
         shadow-lg border
         flex items-center justify-center
         transition-all duration-200
         z-50"
  onclick="scrollChatToBottom()">


  <!-- Down Arrow -->
  <svg xmlns="http://www.w3.org/2000/svg"
       class="h-5 w-5"
       fill="none" viewBox="0 0 24 24"
       stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round"
          d="M19 9l-7 7-7-7"/>
  </svg>
</button>


        <!-- ‚úÖ Use dynamic viewport height; mobile safe -->
        <section id="view-chat"
          class="view hidden flex flex-col"
          style="height: calc(var(--app-vh) - 4rem);">

          <h2 class="font-semibold mb-3 max-w-3xl w-full mx-auto px-0 sm:px-6">
            <!-- Tutor Chat -->
          </h2>

          <!-- SCROLL AREA -->
          <div id="chatScroll" class="flex-1 overflow-y-auto">
            <div id="chatOut"
              class="max-w-3xl w-full mx-auto px-0 sm:px-6 py-4 sm:py-6 space-y-4 pb-40">
              <!-- chat rows injected here -->
            </div>
          </div>

          <!-- INPUT BAR -->
          <!-- ‚úÖ Sticky bottom on mobile + safe tap targets -->
          <div class="border-t bg-white/90 dark:bg-gray-900/90 backdrop-blur sticky bottom-0 z-30">
            <div class="max-w-3xl w-full mx-auto px-0 sm:px-6 py-4 sm:py-6">
              <div class="relative">

                <textarea id="chatMsg"
                  rows="1"
                  placeholder="Ask a question‚Ä¶"
                  class="w-full resize-none rounded-2xl border p-4 pr-16
                         max-h-40 sm:max-h-60 overflow-y-auto
                         dark:bg-gray-800 dark:border-gray-700 focus:outline-none"
                  oninput="autoGrow(this)"></textarea>

                <button id="chatSendBtn"
                  onclick="chat()"
                  class="absolute right-3 bottom-3
                         h-11 w-11 sm:h-10 sm:w-10
                         rounded-full bg-black text-white
                         flex items-center justify-center
                         active:scale-95 disabled:opacity-50">

                  <!-- DEFAULT ICON (shown when empty) -->
                  <svg id="chatDefaultIcon"
                      xmlns="http://www.w3.org/2000/svg"
                      class="h-5 w-5"
                      viewBox="0 0 24 24"
                      fill="currentColor">
                    <path d="M3 12h2v-2H3v2zm4 4h2V8H7v8zm4 2h2V6h-2v10zm4-4h2v-2h-2v2zm4-6h2v4h-2V8z"/>
                  </svg>

                  <!-- SEND ICON -->
                  <svg id="chatSendIcon" xmlns="http://www.w3.org/2000/svg"
                      class="hidden h-5 w-5" fill="none" viewBox="0 0 24 24"
                      stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M12 19V7m0 0l-6 6m6-6l6 6"/>
                  </svg>

                  <!-- LOADING -->
                  <svg id="chatLoadingIcon"
                      class="hidden h-5 w-5 animate-spin"
                      viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"
                            stroke="currentColor" stroke-width="4"
                            class="opacity-25"/>
                    <path d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                          class="opacity-75"
                          fill="currentColor"/>
                  </svg>
                </button>

              </div>
            </div>
          </div>

        </section>

        <!-- ================= INGEST ================= -->
        <section id="view-ingest" class="view hidden max-w-3xl mx-auto">
          <h2 class="font-semibold mb-2">Ingest Knowledge</h2>
          <textarea id="kbText" class="input h-32"></textarea>
          <input id="kbSource" class="input" placeholder="Source name"/>
          <button onclick="ingest()" class="btn">Ingest</button>
          <pre id="ingestOut" class="output mt-3"></pre>
        </section>

        <!-- ================= LESSON ================= -->
        <section id="view-lesson" class="view hidden max-w-3xl mx-auto">
          <h2 class="font-semibold mb-2">Lesson Generator</h2>

          <input id="subj" class="input" placeholder="Subject"/>
          <input id="topic" class="input" placeholder="Topic"/>
          <input id="level" class="input" value="College of Education"/>
          <input id="dur" class="input" type="number" value="40"/>

          <button id="lessonBtn" onclick="lesson()" class="btn flex items-center gap-2 justify-center w-full sm:w-auto">
            <span id="lessonBtnText">Generate</span>
            <svg id="lessonSpinner" class="hidden w-4 h-4 animate-spin" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"/>
              <path d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z" class="opacity-75" fill="currentColor"/>
            </svg>
          </button>

          <pre id="lessonOut" class="output mt-3"></pre>
        </section>

        <!-- ================= RUBRIC ================= -->
        <section id="view-rubric" class="view hidden max-w-3xl mx-auto">
          <h2 class="font-semibold mb-2">Rubric Feedback</h2>
          <textarea id="lessonText" class="input h-28"></textarea>
          <textarea id="rubricText" class="input h-28"></textarea>
          <button onclick="feedback()" class="btn">Evaluate</button>
          <pre id="fbOut" class="output mt-3"></pre>
        </section>

        <!-- ================= SURVEY ================= -->
        <section id="view-survey"
          class="view hidden max-w-5xl mx-auto bg-white dark:bg-gray-900 shadow rounded-lg p-4 sm:p-5">

          <h2 class="text-xl font-semibold mb-4 text-center">
            ICT Instruction Survey
          </h2>

          <!-- Progress Bar -->
          <div class="mb-4">
            <div class="flex justify-between text-xs mb-1">
              <span>Progress</span>
              <span id="progressText">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded h-2">
              <div id="progressBar" class="bg-blue-600 h-2 rounded transition-all duration-300" style="width:0%"></div>
            </div>
          </div>

          <!-- Likert Scale Guide -->
          <div class="mb-4 p-3 rounded-lg bg-gray-50 dark:bg-gray-800 text-sm">
            <p class="font-semibold mb-2 text-center">Response Guide</p>

            <!-- ‚úÖ better on mobile -->
            <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 text-center">
              <div class="border rounded p-2">
                <span class="font-bold">SD</span><br>
                <span class="text-xs text-gray-600 dark:text-gray-300">Strongly Disagree</span>
              </div>
              <div class="border rounded p-2">
                <span class="font-bold">D</span><br>
                <span class="text-xs text-gray-600 dark:text-gray-300">Disagree</span>
              </div>
              <div class="border rounded p-2">
                <span class="font-bold">N</span><br>
                <span class="text-xs text-gray-600 dark:text-gray-300">Neutral</span>
              </div>
              <div class="border rounded p-2">
                <span class="font-bold">A</span><br>
                <span class="text-xs text-gray-600 dark:text-gray-300">Agree</span>
              </div>
              <div class="border rounded p-2">
                <span class="font-bold">SA</span><br>
                <span class="text-xs text-gray-600 dark:text-gray-300">Strongly Agree</span>
              </div>
            </div>
          </div>

          <!-- Controls -->
          <div class="flex flex-col sm:flex-row justify-center gap-3 mb-4">
            <select id="sampleSize" class="border rounded px-3 py-2">
              <option>20</option>
              <option selected>40</option>
              <option>50</option>
            </select>
            <button onclick="buildSurvey()" class="btn w-full sm:w-auto">Apply</button>
          </div>

          <!-- Survey Table -->
<div class="overflow-x-auto">
  <table class="w-full border rounded text-center mb-4 text-sm sm:text-base">
    <thead class="bg-gray-100 dark:bg-gray-800">
      <tr>
        <th class="p-2 w-16">R</th>

        <!-- ‚úÖ NEW COLUMN (Statement) -->
        <th class="p-2 text-left min-w-[320px]">Statement</th>

        <th title="Strongly Disagree" class="cursor-help w-16">SD</th>
        <th title="Disagree" class="cursor-help w-16">D</th>
        <th title="Neutral" class="cursor-help w-16">N</th>
        <th title="Agree" class="cursor-help w-16">A</th>
        <th title="Strongly Agree" class="cursor-help w-16">SA</th>
      </tr>
    </thead>
    <tbody id="surveyBody"></tbody>
  </table>
</div>


          <!-- Pagination (Sticky on Mobile) -->
          <div class="sticky bottom-0 bg-white dark:bg-gray-900 py-3 flex justify-between items-center border-t mt-4">
            <button onclick="prevPage()" class="btn">‚¨Ö Prev</button>
            <span id="pageIndicator" class="text-sm font-medium"></span>
            <button onclick="nextPage()" class="btn">Next ‚û°</button>
          </div>

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row justify-center gap-3">
            <button onclick="submitSurvey()" class="btn w-full sm:w-auto">Submit</button>
            <button data-role="admin" onclick="viewSurveyAnalysis()" class="btn w-full sm:w-auto">Analysis</button>
            <button data-role="admin" onclick="exportSurvey()" class="btn w-full sm:w-auto">Export</button>
          </div>
        </section>

       
        <!-- ================= SURVEY RESPONSES (ADMIN) ================= -->
<section id="view-survey-responses"
  class="view hidden max-w-6xl mx-auto bg-white dark:bg-gray-900 shadow rounded-lg p-4 sm:p-5">

  <h2 class="text-xl font-semibold mb-4 text-center">
    Survey Responses (Admin)
  </h2>

  <!-- ================= QUESTION LEGEND ================= -->
  <div class="mb-5 p-4 rounded-lg bg-gray-50 dark:bg-gray-800 text-sm leading-relaxed">
    <h3 class="font-semibold mb-2">
      Survey Statements (R1‚ÄìR40)
    </h3>

    <p class="mb-2 text-gray-600 dark:text-gray-300">
      Please interpret the response codes below using the following statements.
      Each response was rated on a 5-point Likert scale
      (Strongly Disagree ‚Üí Strongly Agree).
    </p>

    <ol class="list-decimal ml-5 space-y-1">
      <li><strong>R1:</strong> I am familiar with the use of ICT tools in teaching and learning activities.</li>
      <li><strong>R2:</strong> I have received basic training on the use of ICT for instructional purposes.</li>
      <li><strong>R3:</strong> I feel confident using ICT tools to support teaching and lesson preparation.</li>
      <li><strong>R4:</strong> I understand how ICT can enhance pedagogical practices in the classroom.</li>
      <li><strong>R5:</strong> I am willing to integrate ICT tools into my future teaching practice.</li>

      <li><strong>R6:</strong> ICT tools help me plan lessons more effectively.</li>
      <li><strong>R7:</strong> ICT integration improves learner engagement during lessons.</li>
      <li><strong>R8:</strong> I use ICT tools to support diverse learning styles.</li>
      <li><strong>R9:</strong> ICT resources make abstract concepts easier to explain.</li>
      <li><strong>R10:</strong> ICT integration improves my classroom management.</li>

      <li><strong>R11:</strong> I regularly use digital teaching materials provided by my institution.</li>
      <li><strong>R12:</strong> I can independently search for relevant ICT teaching resources.</li>
      <li><strong>R13:</strong> ICT tools support collaborative learning among students.</li>
      <li><strong>R14:</strong> I feel motivated to experiment with new ICT-based teaching strategies.</li>
      <li><strong>R15:</strong> ICT integration improves assessment and feedback practices.</li>

      <li><strong>R16:</strong> My college provides adequate ICT infrastructure for teaching.</li>
      <li><strong>R17:</strong> Internet access in my institution supports effective teaching.</li>
      <li><strong>R18:</strong> Technical support is available when ICT tools fail.</li>
      <li><strong>R19:</strong> ICT facilities are accessible during lesson preparation.</li>
      <li><strong>R20:</strong> Institutional policies encourage ICT-integrated instruction.</li>

      <li><strong>R21:</strong> ICT helps me align lessons with curriculum objectives.</li>
      <li><strong>R22:</strong> ICT use promotes learner-centered teaching.</li>
      <li><strong>R23:</strong> ICT tools support formative assessment practices.</li>
      <li><strong>R24:</strong> ICT integration enhances critical thinking among learners.</li>
      <li><strong>R25:</strong> ICT use supports inclusive education.</li>

      <li><strong>R26:</strong> I received guidance on ICT integration during teaching practice.</li>
      <li><strong>R27:</strong> Supervisors encourage ICT use during practicum.</li>
      <li><strong>R28:</strong> ICT use improved my teaching confidence during practicum.</li>
      <li><strong>R29:</strong> ICT tools helped me manage large classes effectively.</li>
      <li><strong>R30:</strong> ICT use enhanced lesson delivery during teaching practice.</li>

      <li><strong>R31:</strong> I intend to use ICT regularly in my future teaching career.</li>
      <li><strong>R32:</strong> ICT skills are essential for modern teachers.</li>
      <li><strong>R33:</strong> ICT integration prepares students for the digital world.</li>
      <li><strong>R34:</strong> ICT improves teaching effectiveness overall.</li>
      <li><strong>R35:</strong> ICT integration should be mandatory in teacher education.</li>

      <li><strong>R36:</strong> Lack of training limits effective ICT use.</li>
      <li><strong>R37:</strong> Limited resources hinder ICT-integrated teaching.</li>
      <li><strong>R38:</strong> Time constraints affect ICT use in lessons.</li>
      <li><strong>R39:</strong> Power supply challenges affect ICT integration.</li>
      <li><strong>R40:</strong> Despite challenges, ICT integration is beneficial for teaching.</li>
    </ol>
  </div>

  <!-- ================= RESPONSES TABLE ================= -->
  <div class="overflow-x-auto">
    <table class="w-full border rounded text-sm text-center">
      <thead class="bg-gray-100 dark:bg-gray-800">
        <tr>
          <th>ID</th>
          <th>R1</th><th>R2</th><th>R3</th><th>R4</th><th>R5</th>
          <th>R6</th><th>R7</th><th>R8</th><th>R9</th><th>R10</th>
          <th>Role</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="responsesBody"></tbody>
    </table>
  </div>

  <!-- ================= PAGINATION ================= -->
  <div class="flex flex-col sm:flex-row justify-between items-center mt-4 gap-3">
    <button id="respPrevBtn"
      onclick="prevRespPage()"
      class="btn disabled:opacity-40 w-full sm:w-auto"
      disabled>
      ‚¨Ö Prev
    </button>

    <span id="respPageInfo" class="text-sm"></span>

    <button id="respNextBtn"
      onclick="nextRespPage()"
      class="btn disabled:opacity-40 w-full sm:w-auto"
      disabled>
      Next ‚û°
    </button>
  </div>

</section>


        <!-- ================= LOGS ================= -->
        <section id="view-logsSection" class="view hidden max-w-4xl mx-auto">
          <h2 class="font-semibold mb-2">System Logs</h2>
          <pre id="logsOut" class="output"></pre>
        </section>

      </main>
    </div>
  </div>

  <!-- Keep your existing utility styles -->
  <style>
    .nav-btn{width:100%;text-align:left;padding:.5rem;border-radius:.5rem}
    .nav-btn:hover{background:#374151}
    .btn{padding:.6rem 1rem;background:black;color:white;border-radius:.65rem}
    .input{width:100%;border:1px solid #ccc;padding:.6rem;border-radius:.65rem;margin-bottom:.6rem}
    .output{background:#e5e7eb;padding:1rem;border-radius:.75rem;white-space:pre-wrap}
  </style>

</body>
</html>



<script>
/* =============================
   HELPERS
============================= */
const el = (id) => document.getElementById(id);

/* ‚úÖ Mobile viewport height fix (keyboard-safe) */
function fixMobileVH(){
  document.documentElement.style.setProperty("--app-vh", window.innerHeight + "px");
}
window.addEventListener("resize", fixMobileVH);
fixMobileVH();

function toggleSidebar(){
  const sb = el("sidebar");
  if(sb) sb.classList.toggle("hidden");
}

function toggleDarkMode(){
  document.documentElement.classList.toggle("dark");
}

function autoGrow(t){
  if(!t) return;
  t.style.height = "auto";
  t.style.height = t.scrollHeight + "px";
}

/* =============================
   GLOBALS (chat elements)
============================= */
const chatInput    = el("chatMsg");
const defaultIcon  = el("chatDefaultIcon");
const sendIcon     = el("chatSendIcon");

/* Scroll button elements */
let chatScroll = null;
let scrollBtn  = null;
let updateScrollBtn = null;

/* =============================
   CHAT INPUT ICON LOGIC + ENTER SEND
============================= */
if(chatInput && defaultIcon && sendIcon){

  chatInput.addEventListener("input", () => {
    if (chatInput.value.trim().length > 0) {
      defaultIcon.classList.add("hidden");
      sendIcon.classList.remove("hidden");
    } else {
      sendIcon.classList.add("hidden");
      defaultIcon.classList.remove("hidden");
    }
  });

  // ENTER sends message (Shift+Enter = new line)
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      chat();
    }
  });
}

/* =============================
   ROLE + NAV
============================= */
function setRole(role){
  document.querySelectorAll("[data-role]").forEach(btn=>{
    const r = btn.dataset.role;
    btn.style.display = (role === "admin" || r === "all" || r === role) ? "block" : "none";
  });
  showView("chat");
}

function showView(name){
  document.querySelectorAll(".view").forEach(v => v.classList.add("hidden"));

  const view = el("view-" + name);
  if (view) view.classList.remove("hidden");

  // ‚úÖ Auto-close sidebar on mobile
  if (window.innerWidth < 768) {
    const sb = el("sidebar");
    if(sb) sb.classList.add("hidden");
  }

  window.scrollTo({ top: 0, behavior: "smooth" });

  // If chat view opened, refresh scroll button state
  if(name === "chat" && typeof updateScrollBtn === "function"){
    requestAnimationFrame(() => updateScrollBtn());
  }
}

/* =============================
   CHATGPT-STYLE SCROLL BUTTON
============================= */
function initScrollButton(){
  chatScroll = el("chatScroll");
  scrollBtn  = el("scrollToBottomBtn");

  if(!chatScroll || !scrollBtn) return;

  updateScrollBtn = function(){
    const distanceToBottom =
      chatScroll.scrollHeight - chatScroll.scrollTop - chatScroll.clientHeight;

    const nearBottom = distanceToBottom < 120;

    if(nearBottom){
      scrollBtn.classList.add("hidden");
    } else {
      scrollBtn.classList.remove("hidden");
    }
  };

  // Click scroll to bottom
  scrollBtn.addEventListener("click", () => {
    chatScroll.scrollTop = chatScroll.scrollHeight;
    scrollBtn.classList.add("hidden");
  });

  // Show/hide when user scrolls
  chatScroll.addEventListener("scroll", () => {
    updateScrollBtn();
  });

  // Initial state
  updateScrollBtn();
}

/* =============================
   CHAT FUNCTION
============================= */


async function streamType(element, text, scrollContainer){
  let buffer = "";
  let i = 0;

  const speed = 12; // lower = faster typing

  while(i < text.length){
    buffer += text[i];

    // ‚úÖ keep prose wrapper always
    element.innerHTML = `<div class="prose prose-sm max-w-none prose-gray dark:prose-invert">${marked.parse(buffer)}</div>`;

    if(scrollContainer){
      scrollContainer.scrollTop = scrollContainer.scrollHeight;
    }

    i++;
    await new Promise(r => setTimeout(r, speed));
  }
}



async function chat(){
  if(!chatInput) return;

  const msg = chatInput.value.trim();
  if(!msg) return;

  const chatOut = el("chatOut");
  const scroll  = el("chatScroll");

  /* USER BUBBLE */
  const userRow = document.createElement("div");
  userRow.className = "chat-row user";

  const userBubble = document.createElement("div");
  userBubble.className = "bubble bg-black text-white";

  const userContent = document.createElement("div");
  userContent.textContent = msg;

  userBubble.appendChild(userContent);
  userRow.appendChild(userBubble);
  chatOut.appendChild(userRow);

  /* RESET INPUT */
  chatInput.value = "";
  autoGrow(chatInput);

  if(sendIcon && defaultIcon){
    sendIcon.classList.add("hidden");
    defaultIcon.classList.remove("hidden");
  }

  /* LOADING STATE */
  el("chatSendBtn").disabled = true;
  el("chatLoadingIcon").classList.remove("hidden");

  // Scroll to bottom immediately after user bubble
  requestAnimationFrame(() => {
    if(scroll) scroll.scrollTop = scroll.scrollHeight;
    if(typeof updateScrollBtn === "function") updateScrollBtn();
  });

  try{
    const r = await fetch("/api/chat",{
      method:"POST",
      credentials:"same-origin",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ message: msg })
    });

    // if(!r.ok) throw new Error("Bad response");

    // const reply = await r.text();
    if (!r.ok) {
  const text = await r.text();
  alert(
    "STATUS: " + r.status + "\n\n" +
    "SERVER RESPONSE:\n" +
    text.substring(0, 300)
  );
  throw new Error("Request failed");
}

const reply = await r.text();


    /* AI BUBBLE */
const aiRow = document.createElement("div");
aiRow.className = "chat-row assistant";

const aiBubble = document.createElement("div");
aiBubble.className = "bubble";

// ‚úÖ container that will always hold prose wrapper
const aiContent = document.createElement("div");
aiContent.className = "ai-content";

// initial render (optional, but nice)
aiContent.innerHTML = `<div class="prose prose-sm max-w-none prose-gray dark:prose-invert">${marked.parse("")}</div>`;

aiBubble.appendChild(aiContent);
aiRow.appendChild(aiBubble);
chatOut.appendChild(aiRow);

// ‚è≥ STREAM TYPING (this will fill the prose wrapper)
await streamType(aiContent, reply, scroll);


  }catch(e){
    const errRow = document.createElement("div");
    errRow.className = "chat-row";

    const errBubble = document.createElement("div");
    errBubble.className = "bubble bg-red-100 text-red-700";
    errBubble.textContent = "‚ùå Error contacting server";

    errRow.appendChild(errBubble);
    chatOut.appendChild(errRow);

  }finally{
    el("chatLoadingIcon").classList.add("hidden");
    el("chatSendBtn").disabled = false;

    requestAnimationFrame(() => {
      if(scroll) scroll.scrollTop = scroll.scrollHeight;
      if(typeof updateScrollBtn === "function") updateScrollBtn();
    });
  }
}

/* =============================
   INGEST
============================= */
async function ingest(){
  const r = await fetch("/api/ingest",{
    method:"POST",
    credentials:"same-origin",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text:el("kbText").value,source:el("kbSource").value})
  });
  el("ingestOut").textContent=await r.text();
}

/* =============================
   LESSON
============================= */
async function lesson(){
  const btn = el("lessonBtn");
  const btnText = el("lessonBtnText");
  const spinner = el("lessonSpinner");
  const out = el("lessonOut");

  btn.disabled = true;
  btnText.textContent = "Generating...";
  spinner.classList.remove("hidden");
  out.textContent = "‚è≥ Generating lesson, please wait...\n";

  try {
    const r = await fetch("/api/lesson",{
      method:"POST",
      credentials:"same-origin",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        subject:el("subj").value,
        topic:el("topic").value,
        level:el("level").value,
        duration_min:+el("dur").value
      })
    });

    if(!r.ok) throw new Error(`Server error ${r.status}`);
    out.textContent = await r.text();

  } catch (e) {
    out.textContent = "‚ùå Error: " + e.message;
    console.error(e);

  } finally {
    btn.disabled = false;
    btnText.textContent = "Generate";
    spinner.classList.add("hidden");
  }
}

/* =============================
   FEEDBACK
============================= */
async function feedback(){
  const r = await fetch("/api/feedback",{
    method:"POST",
    credentials:"same-origin",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      lesson_text:el("lessonText").value,
      rubric_text:el("rubricText").value
    })
  });
  el("fbOut").textContent=await r.text();
}

/* =============================
   SURVEY
============================= */
let currentPage = 1;
let pageSize = 10;
let totalQuestions = 40;
let answers = {};

function buildSurvey(){
  totalQuestions = +el("sampleSize").value || 40;
  currentPage = 1;
  renderSurveyPage();
}



const STATEMENTS = {
  1: "I am familiar with the use of ICT tools (such as computers, projectors, and educational software) in teaching and learning activities.",
  2: "I have received basic training on the use of ICT for instructional purposes.",
  3: "I feel confident using ICT tools to support teaching and lesson preparation.",
  4: "I understand how ICT can enhance pedagogical practices in the classroom.",
  5: "I am willing to integrate ICT tools into my future teaching practice.",
  6: "ICT tools help me plan lessons more effectively.",
  7: "ICT integration improves learner engagement during lessons.",
  8: "I use ICT tools to support diverse learning styles in the classroom.",
  9: "ICT resources make abstract concepts easier for learners to understand.",
  10: "ICT integration supports effective classroom management.",
  11: "I regularly use digital teaching materials provided by my institution.",
  12: "I can independently search for relevant ICT teaching resources online/offline.",
  13: "ICT tools support collaborative learning among students.",
  14: "ICT motivates me to try new teaching strategies.",
  15: "ICT integration improves assessment and feedback practices.",
  16: "My college provides adequate ICT infrastructure for teaching and learning.",
  17: "Internet access in my institution supports effective ICT-based teaching.",
  18: "Technical support is available when ICT tools or systems fail.",
  19: "ICT facilities are accessible when I need them for lesson preparation.",
  20: "Institutional policies encourage ICT-integrated instruction.",
  21: "ICT helps me align lesson delivery with curriculum objectives.",
  22: "ICT use promotes learner-centered teaching approaches.",
  23: "ICT tools support formative assessment during lessons.",
  24: "ICT integration enhances critical thinking and problem-solving among learners.",
  25: "ICT use supports inclusive teaching for learners with different needs.",
  26: "I received guidance on ICT integration during teaching practice (practicum).",
  27: "Supervisors encourage ICT use during practicum/teaching practice.",
  28: "ICT use improved my confidence during teaching practice.",
  29: "ICT tools helped me handle large class teaching more effectively.",
  30: "ICT improved lesson delivery during teaching practice.",
  31: "I intend to use ICT regularly in my future teaching career.",
  32: "ICT skills are essential for modern teachers.",
  33: "ICT integration prepares learners for the digital world.",
  34: "ICT improves teaching effectiveness overall.",
  35: "ICT integration should be compulsory in teacher education programmes.",
  36: "Lack of training limits effective ICT integration in teaching.",
  37: "Limited ICT resources hinder ICT-integrated teaching in my institution.",
  38: "Time constraints affect how often I use ICT tools in lessons.",
  39: "Power supply challenges affect ICT integration in teaching.",
  40: "Despite challenges, ICT integration is beneficial for teaching and learning."
};


function renderSurveyPage(){
  const tbody = el("surveyBody");
  tbody.innerHTML = "";

  const start = (currentPage - 1) * pageSize + 1;
  const end = Math.min(start + pageSize - 1, totalQuestions);
for(let i = start; i <= end; i++){
  let row = `
    <tr class="border-t question-row" data-q="${i}">
      <td class="p-2 font-semibold w-16">R${i}</td>

      <!-- ‚úÖ STATEMENT COLUMN -->
      <td class="p-2 text-left min-w-[320px]">
        ${STATEMENTS[i] || ""}
      </td>

      ${[1,2,3,4,5].map(v => `
  <td class="w-16">
    <input type="radio"
           name="r${i}"
           value="${v}"
           ${answers[i] === v ? "checked" : ""}
           onchange="saveAnswer(${i}, ${v})">
  </td>
`).join("")}

    </tr>
  `;
  tbody.insertAdjacentHTML("beforeend", row);
}


  el("pageIndicator").innerText =
    `Page ${currentPage} of ${Math.ceil(totalQuestions / pageSize)}`;

  updateProgress();
}

function saveAnswer(q, v){
  answers[q] = v;
  updateProgress();
}

function updateProgress(){
  const answeredCount = Object.keys(answers).length;
  const percent = Math.round((answeredCount / totalQuestions) * 100);

  if(el("progressBar")) el("progressBar").style.width = percent + "%";
  if(el("progressText")) el("progressText").innerText = percent + "% completed";

  const start = (currentPage - 1) * pageSize + 1;
  const end = Math.min(start + pageSize - 1, totalQuestions);

  for(let i = start; i <= end; i++){
    const row = document.querySelector(`tr[data-q="${i}"]`);
    if(!row) continue;
    answers[i] ? row.classList.remove("bg-red-50") : row.classList.add("bg-red-50");
  }
}

function nextPage(){
  if(currentPage < Math.ceil(totalQuestions / pageSize)){
    currentPage++;
    renderSurveyPage();
  }
}

function prevPage(){
  if(currentPage > 1){
    currentPage--;
    renderSurveyPage();
  }
}

async function submitSurvey(){
  // ‚úÖ Validation
  for(let i = 1; i <= totalQuestions; i++){
    if(answers[i] === undefined){
      alert(`Please complete question R${i}`);
      return;
    }
  }

  const payload = { respondent_id: Date.now(), role: "{{ role }}" };
  for(let i = 1; i <= totalQuestions; i++){
    payload[`R${i}`] = answers[i];
  }

  const r = await fetch("/api/survey/submit",{
    method:"POST",
    credentials:"same-origin",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  alert(await r.text());

  /* =========================
     üîÑ RESET RADIOS (ONLY)
  ========================= */

  answers = {};          // clear stored answers
  currentPage = 1;       // go back to page 1
  renderSurveyPage();    // rebuild table (unchecks radios)

  // reset progress bar
  if(el("progressBar")) el("progressBar").style.width = "0%";
  if(el("progressText")) el("progressText").innerText = "0% completed";
}





/* =============================
   SURVEY ANALYSIS + EXPORT
============================= */
async function viewSurveyAnalysis(){
  const r = await fetch("/api/survey/analysis",{credentials:"same-origin"});
  el("logsOut").textContent = await r.text();
  showView("logsSection");
}
function exportSurvey(){ window.location="/api/survey/export"; }

/* =============================
   LOGS
============================= */
async function logs(){
  const r = await fetch("/api/logs",{credentials:"same-origin"});
  el("logsOut").textContent = await r.text();
  showView("logsSection");
}

/* =============================
   ADMIN: SURVEY RESPONSES
============================= */
let currentRespPage = 1;
let respTotalPages = 1;

async function loadResponses(page = 1){
  if(page < 1) return;

  const r = await fetch(`/api/survey/responses?page=${page}`, {credentials:"same-origin"});
  if(!r.ok){
    alert("Failed to load responses");
    return;
  }

  const data = await r.json();
  currentRespPage = data.page;
  respTotalPages = data.pages;

  const tbody = el("responsesBody");
  tbody.innerHTML = "";

  if(data.data.length === 0){
    tbody.innerHTML = `
      <tr><td colspan="14" class="p-4 text-center text-gray-500">
        No survey responses yet
      </td></tr>`;
  } else {
    data.data.forEach(row=>{
      const tr = document.createElement("tr");
      tr.className = "border-t";
      row.forEach(v=>{
        const td = document.createElement("td");
        td.className = "p-2";
        td.textContent = v;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  el("respPageInfo").innerText = `Page ${currentRespPage} of ${respTotalPages}`;
  updateRespButtons();
}

function updateRespButtons(){
  const prevBtn = el("respPrevBtn");
  const nextBtn = el("respNextBtn");
  if(prevBtn) prevBtn.disabled = currentRespPage <= 1;
  if(nextBtn) nextBtn.disabled = currentRespPage >= respTotalPages;
}

function nextRespPage(){
  if(currentRespPage < respTotalPages) loadResponses(currentRespPage + 1);
}

function prevRespPage(){
  if(currentRespPage > 1) loadResponses(currentRespPage - 1);
}

/* =============================
   INIT
============================= */
document.addEventListener("DOMContentLoaded", () => {
  setRole("{{ role }}");
  buildSurvey();

  // Ensure correct icon state on load
  if(sendIcon && defaultIcon){
    sendIcon.classList.add("hidden");
    defaultIcon.classList.remove("hidden");
  }

  // ‚úÖ start scroll-to-bottom feature
  initScrollButton();
});








function showView(name){
  document.querySelectorAll(".view").forEach(v => v.classList.add("hidden"));

  const view = el("view-" + name);
  if (view) view.classList.remove("hidden");

  if (window.innerWidth < 768) {
    const sb = el("sidebar");
    if(sb) sb.classList.add("hidden");
  }

  window.scrollTo({ top: 0, behavior: "smooth" });

  if(name === "chat" && typeof updateScrollBtn === "function"){
    requestAnimationFrame(() => updateScrollBtn());
  }

  // ‚úÖ FIX: load survey responses
  if(name === "survey-responses"){
    loadResponses(1);
  }
}








</script>






<style>
.nav-btn{width:100%;text-align:left;padding:.5rem;border-radius:.5rem}
.nav-btn:hover{background:#374151}
.btn{padding:.5rem 1rem;background:black;color:white;border-radius:.5rem}
.input{width:100%;border:1px solid #ccc;padding:.5rem;border-radius:.5rem;margin-bottom:.5rem}
.output{background:#e5e7eb;padding:1rem;border-radius:.75rem;white-space:pre-wrap}



/* Chrome, Edge, Safari */
#chatMsg::-webkit-scrollbar {
  width: 0px;
  height: 0px;
}

#chatMsg::-webkit-scrollbar-thumb {
  background: transparent;
}

#chatMsg::-webkit-scrollbar-track {
  background: transparent;
}

/* Firefox */
#chatMsg {
  scrollbar-width: none;      /* Firefox */
  -ms-overflow-style: none;   /* IE / Edge legacy */
}

#chatScroll::-webkit-scrollbar { width: 0; height: 0; }
#chatScroll { scrollbar-width: none; }





</style>

</body>
</html>
